Humphrey.DOM.posts=$("#posts"),Humphrey.DOM.addNewButton=$("#post-add-new"),Humphrey.DOM.postEditor=$("#post-editor"),Humphrey.DOM.title=$("#title"),Humphrey.DOM.textarea=$("#data"),Humphrey.DOM.file=$("#file"),Humphrey.DOM.button=$("#upload-button"),function(a){Humphrey.loadPosts=function(){Humphrey.S3.listObjects({Prefix:"posts/"},function(b,c){c.Contents||(c.Contents=[]),c.Contents.forEach(function(b){var c=b.Key;b.Size>0&&Humphrey.S3.getObject({Bucket:Humphrey.BUCKET,Key:c},function(b,d){if(b&&console.log(b),d){var e=JSON.parse(d.Body.toString()),f=c.replace(/^posts\/|.json$/g,""),g=$('<option value="'+f+'">'+e.title+"</option>");a.posts.append(g)}})}),a.posts.on("change",Humphrey.updateView),a.button.on("click",Humphrey.updatePost)})},Humphrey.showEditor=function(){a.postEditor.show()},Humphrey.clearValues=function(){a.posts.val(""),a.title.val(""),a.textarea.html(""),a.file.val("")},Humphrey.updateView=function(){Humphrey.showEditor(),Humphrey.SITE.activePost=this.value,Humphrey.S3.getObject({Bucket:Humphrey.BUCKET,Key:"posts/"+Humphrey.SITE.activePost+".json"},function(b,c){if(b&&console.log(b),c){var d=JSON.parse(c.Body.toString()),e=new Date(d.updated);a.title.val(d.title),a.textarea.html(d.content),Humphrey.UTILS.notify("Last updated: "+Humphrey.UTILS.formatDate(e))}})},Humphrey.updatePostJSON=function(){var b=a.title.val(),c=Humphrey.UTILS.slugify(b),d=a.textarea.val(),e=a.file.files.length>0?a.file.files[0].name:!1,f={Key:"posts/"+c+".json",ContentType:"application/json",Body:JSON.stringify({content:d,title:b,media:e,updated:new Date})};Humphrey.S3.putObject(f,function(a){Humphrey.UTILS.notify(a?"DATA ERROR!":"DATA SAVED.",!0)})},Humphrey.renderPost=function(){},Humphrey.updatePost=function(){Humphrey.UTILS.notify("");var b=a.textarea.val(),c=Humphrey.SITE.activePost?Humphrey.SITE.activePost:Humphrey.UTILS.slugify(a.title.val()),d=a.file.files?a.file.files[0]:!1;d&&Humphrey.addMedia(d),Humphrey.updatePostJSON();var e=Humphrey.SITE.activeThemeHeader,f=Humphrey.SITE.activeThemeFooter,g={title:title.val(),date:Humphrey.UTILS.formatDate(new Date)};e=Humphrey.filterContent(Humphrey.SITE.activeTheme.files["header.html"],g),b=Humphrey.filterContent(b,g),f=Humphrey.filterContent(Humphrey.SITE.activeTheme.files["header.html"],g),params={Body:e+b+f,ContentType:"text/html",Key:"site/"+c+"/index.html"},Humphrey.S3.putObject(params,function(a){Humphrey.UTILS.notify(a?"POST ERROR!":"POST SAVED.",!0)})},a.addNewButton.on("click",function(){Humphrey.clearValues(),Humphrey.showEditor()})}(Humphrey.DOM);